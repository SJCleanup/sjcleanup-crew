<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SJCleanup - Crew Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .tab-active { background: #3b82f6; color: white; }
        .job-card { transition: transform 0.2s; }
        .job-card:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center mb-2">üßπ SJCleanup</h1>
            <p class="text-gray-400 text-center mb-8">Crew Portal</p>
            
            <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
                <label class="block text-sm text-gray-400 mb-2">Enter your PIN</label>
                <input type="tel" id="pinInput" maxlength="6" 
                    class="w-full bg-gray-700 border-2 border-gray-600 rounded-xl px-4 py-4 text-2xl text-center tracking-widest focus:border-blue-500 focus:outline-none"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" pattern="[0-9]*">
                <button onclick="login()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-xl mt-4 transition">
                    Sign In
                </button>
                <p id="loginError" class="text-red-400 text-sm text-center mt-3 hidden"></p>
            </div>
        </div>
    </div>

    <!-- Main App (hidden initially) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 px-4 py-3 flex items-center justify-between sticky top-0 z-10">
            <div>
                <h2 class="font-semibold" id="welcomeMsg">Welcome</h2>
                <p class="text-xs text-gray-400" id="todayDate"></p>
            </div>
            <button onclick="logout()" class="text-gray-400 hover:text-white p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
            </button>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex bg-gray-800 border-t border-gray-700 px-2 py-2 gap-2">
            <button onclick="showTab('jobs')" id="tabJobs" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium tab-active">
                My Jobs
            </button>
            <button onclick="showTab('earnings')" id="tabEarnings" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-gray-400">
                Earnings
            </button>
        </nav>

        <!-- Jobs Tab -->
        <div id="jobsTab" class="p-4">
            <div id="jobsList" class="space-y-3">
                <div class="text-center text-gray-500 py-8">Loading jobs...</div>
            </div>
        </div>

        <!-- Earnings Tab -->
        <div id="earningsTab" class="p-4 hidden">
            <div class="bg-gray-800 rounded-xl p-4 mb-4">
                <p class="text-gray-400 text-sm">Total Earnings</p>
                <p class="text-3xl font-bold text-green-400" id="totalEarnings">$0.00</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-4">
                <p class="text-gray-400 text-sm mb-2">Jobs Completed</p>
                <p class="text-2xl font-semibold" id="jobsCompleted">0</p>
            </div>
        </div>
    </div>

    <!-- Job Detail Modal -->
    <div id="jobModal" class="fixed inset-0 bg-black/80 z-50 hidden">
        <div class="min-h-screen flex items-end sm:items-center justify-center">
            <div class="bg-gray-800 w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-y-auto">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between sticky top-0 bg-gray-800">
                    <h3 class="font-semibold text-lg">Job Details</h3>
                    <button onclick="closeJobModal()" class="p-2 hover:bg-gray-700 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div id="jobModalContent" class="p-4">
                    <!-- Content filled by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 left-4 right-4 bg-gray-700 text-white px-4 py-3 rounded-xl text-center transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        // ===== CONFIGURATION =====
        const API_BASE = 'https://x8ki-letl-twmt.n7.xano.io/api:O_MQ1nmN';
        
        // ===== STATE =====
        let currentWorker = null;
        let currentJobs = [];
        let selectedJob = null;

        // ===== UTILITIES =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'TBD';
            return new Date(dateStr).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        // ===== LOGIN =====
        async function login() {
            const pin = document.getElementById('pinInput').value;
            const errorEl = document.getElementById('loginError');
            
            if (!pin || pin.length < 4) {
                errorEl.textContent = 'Please enter your PIN';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/crew/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                
                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.success) {
                    currentWorker = {
                        id: data.worker_id,
                        name: data.name
                    };
                    localStorage.setItem('crew_worker', JSON.stringify(currentWorker));
                    showMainApp();
                    loadJobs();
                } else {
                    errorEl.textContent = data.message || 'Invalid PIN';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('crew_worker');
            currentWorker = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('pinInput').value = '';
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('welcomeMsg').textContent = `Welcome, ${currentWorker.name}!`;
            document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric' 
            });
        }

        // ===== TABS =====
        function showTab(tab) {
            document.getElementById('jobsTab').classList.toggle('hidden', tab !== 'jobs');
            document.getElementById('earningsTab').classList.toggle('hidden', tab !== 'earnings');
            document.getElementById('tabJobs').classList.toggle('tab-active', tab === 'jobs');
            document.getElementById('tabEarnings').classList.toggle('tab-active', tab === 'earnings');
            document.getElementById('tabJobs').classList.toggle('text-gray-400', tab !== 'jobs');
            document.getElementById('tabEarnings').classList.toggle('text-gray-400', tab !== 'earnings');
            
            if (tab === 'earnings') loadEarnings();
        }

        // ===== JOBS =====
        async function loadJobs() {
            const container = document.getElementById('jobsList');
            
            try {
                const response = await fetch(`${API_BASE}/crew/my-jobs?worker_id=${currentWorker.id}`);
                const data = await response.json();
                console.log('Jobs response:', data);
                
                currentJobs = data.jobs || [];
                
                if (currentJobs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-gray-500 text-lg">No active jobs</p>
                            <p class="text-gray-600 text-sm mt-2">Check back later for new assignments</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = currentJobs.map(job => `
                    <div class="job-card bg-gray-800 rounded-xl p-4 cursor-pointer" onclick="openJobModal(${job.id})">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-semibold">${job.address || 'Address TBD'}</p>
                                <p class="text-sm text-gray-400">${job.city || ''}, ${job.state || 'NJ'}</p>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(job.status)}">
                                ${formatStatus(job.status)}
                            </span>
                        </div>
                        <div class="flex justify-between text-sm mt-3">
                            <span class="text-gray-400">üìÖ ${formatDate(job.scheduled_date)}</span>
                            <span class="text-green-400 font-semibold">${formatCurrency(job.price_worker)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load jobs error:', error);
                container.innerHTML = `<div class="text-center text-red-400 py-8">Failed to load jobs</div>`;
            }
        }

        function getStatusColor(status) {
            const colors = {
                'scheduled': 'bg-blue-500/20 text-blue-400',
                'confirmed': 'bg-purple-500/20 text-purple-400',
                'in_progress': 'bg-yellow-500/20 text-yellow-400',
                'pending_verification': 'bg-orange-500/20 text-orange-400',
                'completed': 'bg-green-500/20 text-green-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        function formatStatus(status) {
            return (status || 'unknown').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // ===== JOB MODAL =====
        function openJobModal(jobId) {
            selectedJob = currentJobs.find(j => j.id === jobId);
            if (!selectedJob) return;

            const content = document.getElementById('jobModalContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-400 text-sm">Address</p>
                        <p class="font-semibold">${selectedJob.address || 'TBD'}</p>
                        <p class="text-gray-400">${selectedJob.city || ''}, ${selectedJob.state || 'NJ'} ${selectedJob.zip || ''}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-400 text-sm">Date</p>
                            <p class="font-semibold">${formatDate(selectedJob.scheduled_date)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">Time</p>
                            <p class="font-semibold">${selectedJob.scheduled_time || 'TBD'}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-400 text-sm">Job Type</p>
                            <p class="font-semibold">${formatStatus(selectedJob.job_type || selectedJob.service_type || 'Cleanup')}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">Your Pay</p>
                            <p class="font-semibold text-green-400">${formatCurrency(selectedJob.price_worker)}</p>
                        </div>
                    </div>

                    ${selectedJob.special_instructions ? `
                        <div>
                            <p class="text-gray-400 text-sm">Instructions</p>
                            <p class="bg-gray-700 rounded-lg p-3 mt-1">${selectedJob.special_instructions}</p>
                        </div>
                    ` : ''}

                    <div class="pt-4 space-y-3">
                        ${getJobActions(selectedJob)}
                    </div>
                </div>
            `;

            document.getElementById('jobModal').classList.remove('hidden');
        }

        function getJobActions(job) {
            switch(job.status) {
                case 'scheduled':
                case 'dispatched':
                    return `
                        <button onclick="startJob(${job.id})" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-semibold">
                            üöÄ Start Job
                        </button>
                    `;
                case 'in_progress':
                    return `
                        <button onclick="completeJob(${job.id})" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-xl font-semibold">
                            ‚úÖ Mark Complete
                        </button>
                    `;
                case 'pending_verification':
                    return `<p class="text-center text-yellow-400">‚è≥ Waiting for admin verification</p>`;
                default:
                    return '';
            }
        }

        function closeJobModal() {
            document.getElementById('jobModal').classList.add('hidden');
            selectedJob = null;
        }

        // ===== JOB ACTIONS =====
        async function startJob(jobId) {
            try {
                const response = await fetch(`${API_BASE}/crew/start-job`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId, crew_id: currentWorker.id })
                });
                
                const data = await response.json();
                console.log('Start job response:', data);
                
                if (data.success) {
                    showToast('Job started! üöÄ');
                    closeJobModal();
                    loadJobs();
                } else {
                    showToast(data.message || 'Failed to start job');
                }
            } catch (error) {
                console.error('Start job error:', error);
                showToast('Connection error');
            }
        }

        async function completeJob(jobId) {
            try {
                const response = await fetch(`${API_BASE}/crew/complete-job`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId, crew_id: currentWorker.id })
                });
                
                const data = await response.json();
                console.log('Complete job response:', data);
                
                if (data.success) {
                    showToast('Job completed! ‚úÖ');
                    closeJobModal();
                    loadJobs();
                } else {
                    showToast(data.message || 'Failed to complete job');
                }
            } catch (error) {
                console.error('Complete job error:', error);
                showToast('Connection error');
            }
        }

        // ===== EARNINGS =====
        async function loadEarnings() {
            try {
                const response = await fetch(`${API_BASE}/worker/my-jobs?worker_id=${currentWorker.id}`);
                const data = await response.json();
                console.log('Earnings response:', data);
                
                const jobs = data.jobs || [];
                const completedJobs = jobs.filter(j => j.status === 'completed' || j.status === 'verified' || j.status === 'paid');
                const totalEarnings = completedJobs.reduce((sum, j) => sum + (j.price_worker || 0), 0);
                
                document.getElementById('totalEarnings').textContent = formatCurrency(totalEarnings);
                document.getElementById('jobsCompleted').textContent = completedJobs.length;
            } catch (error) {
                console.error('Load earnings error:', error);
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved session
            const saved = localStorage.getItem('crew_worker');
            if (saved) {
                currentWorker = JSON.parse(saved);
                showMainApp();
                loadJobs();
            }

            // Enter key to login
            document.getElementById('pinInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
